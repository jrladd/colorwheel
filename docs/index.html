<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<link href="https://fonts.googleapis.com/css?family=Crimson+Text" rel="stylesheet">
<style>

body {
	font-family: 'Crimson Text', serif;
}
.axis text {
  font: 10px sans-serif;
}

.axis line,
.axis path {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}
text, path {cursor: pointer; }
text {
	font-size: 20px;
}
.col1 {width: 600px; float: left;}
.col2 {width: 400px; float: left;}
.line {position: absolute;}
span.red {color: #AA1100; font-weight: bold; }
span.yellow {color: #FFBB11; font-weight: bold; }
span.green {color: #55AA00; font-weight: bold; }
span.blue {color: #0000FF; font-weight: bold; }
span.purple {color: #4B0082; font-weight: bold; }
span.white {color: #FAFAFA;    
  text-shadow:
   -1px -1px 0 #000,  
    1px -1px 0 #000,
    -1px 1px 0 #000,
     1px 1px 0 #000;}
span.black {color: #000000; font-weight: bold; }
span.gray {color: #C0C0C0; font-weight: bold; }
span.brown {color: #884513; font-weight: bold; }

</style>
</head>
<body>
	<div class="col1"></div>
	<div class="col2"></div>
<script   src="https://code.jquery.com/jquery-2.2.4.min.js"   integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="   crossorigin="anonymous"></script>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script>
/*This code adapted from Mike Bostock's Dispatching Events example: https://bl.ocks.org/mbostock/5872848*/

var dispatch = d3.dispatch("load", "statechange");

var groups = [
  "red",
  "yellow",
  "green",
  "blue",
  "purple",
  "white",
  "black",
  "gray",
  "brown"
];

d3.json('line_data.json', function(error, texts) {
	var books = d3.keys(texts);
	textById = d3.map()
	books.forEach(function(d) { 
		textById['_'][d] = {};
		textById['_'][d]['id'] = d;
		textById['_'][d]['lines'] = {};
		groups.forEach(function(k) { 
		if (texts[d].hasOwnProperty(k)) {
			textById['_'][d][k] = texts[d][k].length; 
			textById['_'][d]['lines'][k] = texts[d][k]; 
		}
		else { textById['_'][d][k] = 0; textById['_'][d]['lines'][k] = [];}
		textById['_'][d] = type(textById['_'][d]);
		}); 
	});
	dispatch.load(textById, texts);
	dispatch.statechange(textById.get("Book 1"), texts);
});

// A drop-down menu for selecting a text; uses the "menu" namespace.
dispatch.on("load.menu", function(textById) {
  var select = d3.select(".col1")
    .append("div")
    .append("select")
      .on("change", function() { dispatch.statechange(textById.get(this.value)); });

  select.selectAll("option")
      .data(textById.values())
    .enter().append("option")
      .attr("value", function(d) { return d.id; })
      .text(function(d) { return d.id; });

  dispatch.on("statechange.menu", function(text) {
    select.property("value", text.id);
  });
});

// A bar chart to show total color usage; uses the "bar" namespace.
dispatch.on("load.bar", function(textById) {
  var margin = {top: 20, right: 20, bottom: 30, left: 40},
      width = 80 - margin.left - margin.right,
      height = 460 - margin.top - margin.bottom;

  var y = d3.scale.linear()
      .domain([0, d3.max(textById.values(), function(d) { return d.total; })])
      .rangeRound([height, 0])
      .nice();

  var yAxis = d3.svg.axis()
      .scale(y)
      .orient("left")
      .tickFormat(d3.format(".2s"));

  var svg = d3.select(".col1").append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
    .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  svg.append("g")
      .attr("class", "y axis")
      .call(yAxis);

  var rect = svg.append("rect")
      .attr("x", 4)
      .attr("width", width - 4)
      .attr("y", height)
      .attr("height", 0)
      .style("fill", "#aaa");

  dispatch.on("statechange.bar", function(d) {
    rect.transition()
        .attr("y", y(d.total))
        .attr("height", y(0) - y(d.total));
  });
});

// A pie chart to show number of lines by color; uses the "pie" namespace.
dispatch.on("load.pie", function(textById) {
  var width = 480,
      height = 460,
      radius = Math.min(width, height) / 2;

  var color = d3.scale.ordinal()
      .domain(groups)
      .range(["#AA1100", "#FFBB11", "#55AA00", "#0000FF", "#4B0082", "#FAFAFA", "#000000", "#C0C0C0", "#884513"]);

  var arc = d3.svg.arc()
      .outerRadius(radius - 10)
      .innerRadius(radius - 70);

  var pie = d3.layout.pie()
      .sort(null);

  var svg = d3.select(".col1").append("svg")
      .attr("width", width)
      .attr("height", height)
    .append("g")
      .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

  var path = svg.selectAll("path")
      .data(groups)
    .enter().append("path")
      .style("fill", color)
      .attr("class", function(d) { return d; } )
      .each(function() { this._current = {startAngle: 0, endAngle: 0}; });

  svg.append("text")
	  .text("Shuffle")
	  .attr('text-anchor', 'middle')
	  .attr('transform', 'translate(' + 0 + "," + -30 + ")")
	  .on("click", function() {
		  d3.selectAll("div.line").sort(function(a,b) {
			  return d3.ascending(Math.random(), Math.random());
		  }).transition().duration(500).style('top', function(d, i) { return 10 + ((i*20)) + "px"; } );
	  });

  svg.append('text')
  	  .text('Clear')
	  .attr('text-anchor', 'middle')
	  .attr('transform', 'translate('+ 0 + "," + 30 + ")")
	  .on("click", function() {
		  d3.selectAll("div.line").remove();
	  });

  dispatch.on("statechange.pie", function(d) {
    path.data(pie.value(function(g) { return d[g]; })(groups)).transition()
        .attrTween("d", function(d) {
          var interpolate = d3.interpolate(this._current, d);
          this._current = interpolate(0);
          return function(t) {
            return arc(interpolate(t));
          };
        });
    /* On click, show all lines for that color. Transition and random sort on subsequent clicks. */
    path.on("click", function(c) { 
		var lines = d3.select('div.col2').selectAll('div.line')
			.data(d['lines'][c['data']], function(d) {return d;})	
			.enter().append('div')
			.attr('class', c['data']+' line')
		//	.style('top', function(d, i) { return 10 + ((i*30)) + "px"; } )
			.html( function(d, i) {return d;})

		d3.selectAll('div.line').sort(function(a,b) {
			  return d3.ascending(Math.random(), Math.random());
		  })
			.transition().duration(500)
			.style('top', function(d, i) { return 10 + ((i*20)) + "px"; } );

      });
  });
});


function type(d) {
  d.total = d3.sum(groups, function(k) { return d[k] = +d[k]; });
  return d;
}

</script>
</body>
</html>
